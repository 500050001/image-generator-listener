name: Deploy Contract

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '18'

    - name: Cache Node.js modules
      uses: actions/cache@v2
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install dependencies
      run: |
        cd hardhat
        npm install

    - name: Log Secret Values (for debugging)
      run: |
        echo "Preparing to deploy..."
        echo "INFURA_PROJECT_ID: ${INFURA_PROJECT_ID:0:4}...${INFURA_PROJECT_ID: -4} (Length: ${#INFURA_PROJECT_ID} characters)"
        echo "DEPLOYER_PRIVATE_KEY: ${DEPLOYER_PRIVATE_KEY:0:6}...${DEPLOYER_PRIVATE_KEY: -4} (Length: ${#DEPLOYER_PRIVATE_KEY} characters)"
      env:
        INFURA_PROJECT_ID: ${{ secrets.INFURA_PROJECT_ID }}
        DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
   
    - name: Compile contracts
      run: |
        cd hardhat
        npx hardhat compile

    - name: Deploy Smart Contract
      run: |
        cd hardhat
        npx hardhat run scripts/deploy.js --network sepolia
      env:
        INFURA_PROJECT_ID: ${{ secrets.INFURA_PROJECT_ID }}
        DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPRIVATA_KEY }}

    - name: Save ABI for Frontend
      run: |
        mkdir -p ../frontend/src/abi
        cp artifacts/contracts/ImageRequest.sol/ImageRequest.json ../frontend/src/abi/
